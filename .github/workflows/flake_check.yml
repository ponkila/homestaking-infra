name: "Nix flake check"

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

jobs:
  check:
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install nix
        uses: cachix/install-nix-action@v20

      - name: Check flake
        run: |
          set -o pipefail
          nix flake check --experimental-features "nix-command flakes" --fallback --show-trace -v --log-format raw > >(tee /tmp/nix-flake-check-out.log) 2> >(tee /tmp/nix-flake-check-err.log >&2)

      - name: Output failure
        if: failure()
        run: |
          drv=$(grep "For full logs, run" /tmp/nix-flake-check-err.log | grep -oE "/nix/store/.*.drv")
          nix log $drv
          echo $drv
          exit 1
          